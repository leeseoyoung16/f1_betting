<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>F1 ë² íŒ… & ë ˆì´ìŠ¤</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        /* ===========================================================
           ê¸°ë³¸ ìŠ¤íƒ€ì¼ (UI ì •ëˆ)
        =========================================================== */
        body { font-family: 'Inter', 'Segoe UI', sans-serif; background:#0b0f14; color:#fff; margin:0; text-align:center; display:flex; flex-direction:column; min-height:100vh; }
        .hidden { display:none; }

        /* ===========================================================
           ë¡œê·¸ì¸ / ë¡œë¹„ ì¹´ë“œ ìŠ¤íƒ€ì¼ (UI ì •ëˆ)
        =========================================================== */
        .card {
            width:90%; /* ëª¨ë°”ì¼ ëŒ€ì‘ */
            max-width:450px;
            margin:80px auto;
            padding:30px;
            border-radius:14px;
            background:rgba(255,255,255,0.08);
            backdrop-filter:blur(6px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        input {
            width:100%; /* ì¹´ë“œ ë„ˆë¹„ì— ê½‰ ì°¨ê²Œ ì¡°ì • */
            padding:12px;
            margin:10px 0;
            border-radius:8px;
            border:none;
            font-size:18px;
            color: #0b0f14;
            box-sizing: border-box; /* íŒ¨ë”©ì´ ë„ˆë¹„ì— í¬í•¨ë˜ë„ë¡ */
        }

        /* ë²„íŠ¼ ì»¨í…Œì´ë„ˆ: ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ ì •ë ¬ì„ ìœ„í•´ ì¶”ê°€ */
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        button {
            padding:12px 24px;
            font-size:18px;
            border:none;
            border-radius:10px;
            cursor:pointer;
            font-weight: bold;
            transition: transform 0.1s;
        }

        button:active {
            transform: scale(0.98);
        }

        .btn-blue { background:#4a74ff; color:white; }
        .btn-green { background:#2ecc71; color:white; }
        .btn-red { background:#e74c3c; color:white; }

        /* ===========================================================
           ë ˆì´ìŠ¤ ë° HUD ìŠ¤íƒ€ì¼
        =========================================================== */
        #roundIndicator {
            position:fixed; top:20px; right:22px;
            font-size:28px; color:#ffd700;
            display:none;
        }

        /* ë‹¤ìŒ ë¼ìš´ë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¡°ì • (ì‘ê²Œ) */
        #nextRoundBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background: #4a74ff;
            color: white;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        #raceTrack {
            width:95%;
            max-width:1200px;
            height:330px;
            margin:100px auto 30px; /* ìƒë‹¨ 100px */
            position:relative;
            border-top:4px dashed #aaa;
            border-bottom:4px dashed #aaa;
            display:none;
        }


        #finishLine {
            position:absolute; right:4%; top:0;
            width:12px; height:100%;
            background: repeating-linear-gradient(
                    45deg,white 0,white 12px,black 12px,black 24px
            );
        }

        /* ìë™ì°¨ ì• ë‹ˆë©”ì´ì…˜ */
        .car-container {
            position:absolute; width:200px; transition: top 0.3s ease, left 0.15s linear;
        }

        .car-image {
            width:90px;
            height: auto;
        }


        /* ===========================================================
           ë² íŒ… í˜ì´ì§€ ìŠ¤íƒ€ì¼ (UI ì •ëˆ)
        =========================================================== */
        .betting-page-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            height: 100%;
            box-sizing: border-box;
        }

        .betting-title-area {
            flex-shrink: 0;
            margin-bottom: 30px;
        }

        #bettingCarArea {
            /* ì°¨ëŸ‰ ì¹´ë“œ ì˜ì—­ì€ ìœ ì—°í•˜ê²Œ ë°°ì¹˜ */
            display:flex;
            justify-content:center;
            gap:40px;
            margin-top:20px;
            flex-wrap: wrap;
            padding-bottom: 20px;
        }

        .bet-car-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px 30px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 4px solid transparent;
            min-width: 200px; /* ìµœì†Œ ë„ˆë¹„ ì¤„ì„ */
            flex-grow: 1;
            max-width: 280px;
        }

        .bet-car-card:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .bet-car-card.selected {
            border: 4px solid #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .selected-car-glow {
            animation: glowPulse 1.2s infinite ease-in-out;
            filter: drop-shadow(0 0 12px rgba(255, 215, 0, 0.9))
            drop-shadow(0 0 24px rgba(255, 215, 0, 0.6))
            drop-shadow(0 0 36px rgba(255, 215, 0, 0.4));
        }

        @keyframes glowPulse {
            0% {
                filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.6));
            }
            50% {
                filter: drop-shadow(0 0 20px rgba(255, 215, 0, 1));
            }
            100% {
                filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.6));
            }
        }

        /* ===========================================================
   ê²°ê³¼ ëª¨ë‹¬ (ì •ì‚°ì„œ) ìŠ¤íƒ€ì¼
=========================================================== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none; /* í‰ì†Œì—” ìˆ¨ê¹€ */
            justify-content: center; align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: rgba(20, 24, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            width: 90%; max-width: 500px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            position: relative;
        }

        .modal-title { font-size: 32px; font-weight: bold; margin-bottom: 20px; }
        .text-win { color: #ffd700; text-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
        .text-lose { color: #e74c3c; }

        .result-info {
            font-size: 20px; margin: 15px 0; line-height: 1.6; color: #ddd;
        }
        .result-amount { font-size: 24px; font-weight: bold; color: #fff; }

        .history-list {
            text-align: left;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border-top: 1px solid #444;
            padding-top: 10px;
        }
        .history-item {
            display: flex; justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 18px;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* =============================
   í­ì£½ íš¨ê³¼ (Confetti)
============================= */
        @keyframes confettiFall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .confetti-piece {
            position: fixed;
            top: -10px;
            width: 10px;
            height: 20px;
            background: red;
            opacity: 0.9;
            z-index: 999999;
            animation: confettiFall 1.5s linear forwards;
        }

        /* ëœë¤ ìƒ‰ */
        .confetti-piece:nth-child(5n+1) { background: #ffd700; }
        .confetti-piece:nth-child(5n+2) { background: #ff6b6b; }
        .confetti-piece:nth-child(5n+3) { background: #5f9fff; }
        .confetti-piece:nth-child(5n+4) { background: #6bff9c; }
        .confetti-piece:nth-child(5n+5) { background: #ff9f5f; }

        /* =============================
           í™©ê¸ˆ í”Œë˜ì‹œ ì „ì²´ í™”ë©´
        ============================= */
        #goldFlash {
            position: fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background: radial-gradient(circle, rgba(255,215,0,0.8) 0%, rgba(255,215,0,0) 70%);
            opacity:0;
            pointer-events:none;
            z-index:99998;
            transition: opacity 0.8s ease-out;
        }

        /* =============================
           "ë² íŒ… ì„±ê³µ!" í…ìŠ¤íŠ¸ íš¨ê³¼
        ============================= */
        #betSuccessMessage {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            font-size: 80px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255,215,0,0.8);
            opacity: 0;
            z-index: 999999;
            transition: all 0.4s ease-out;
        }

        #betSuccessMessage.active {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.15);
        }


        .bet-car-card .car-image {
            width: 180px;
            height: auto;
            margin: 10px 0;
            transition: transform 0.3s;
        }

        .bet-car-card:hover .car-image {
            transform: scale(1.05);
        }

        .multiplier {
            font-size: 36px;
            font-weight: bold;
            color: #2ecc71;
        }

        #bettingControl {
            /* ë² íŒ… ì»¨íŠ¸ë¡¤ ì˜ì—­ì€ í•˜ë‹¨ì— ê³ ì • */
            margin-top: auto; /* ë‚¨ì€ ê³µê°„ì„ ë°€ì–´ë‚´ë„ë¡ */
            width: 100%;
            max-width: 400px; /* ì ì ˆí•œ ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
            padding-bottom: 40px;
        }

        #bettingForm input {
            /* ë² íŒ… ì…ë ¥ í•„ë“œ í¬ê¸° ì¡°ì • */
            width: 100%;
            max-width: 300px;
            margin: 15px auto;
            display: block;
        }

        /* ===========================================================
           ìˆœìœ„ í‘œì‹œ ìŠ¤íƒ€ì¼ (ì¼ì§ì„  ì •ë ¬)
        =========================================================== */
        #rankingDisplay {
            width:95%; max-width:1200px; margin: 20px auto 40px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            flex-wrap: nowrap;
            gap: 10px;
            flex-shrink: 0;
            overflow-x: auto;
        }

        .ranking-item {
            font-size: 16px; /* í°íŠ¸ í¬ê¸° ì¡°ì • */
            padding: 8px 10px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            min-width: 120px; /* ìµœì†Œ ë„ˆë¹„ ì¡°ì • */
            text-align: center;
            flex-grow: 1;
            transition: all 0.5s ease-in-out;
        }

        /* ìˆœìœ„ ë³€ë™ ì‹œ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes rank-change-pulse {
            0% { transform: scale(1.0); box-shadow: 0 0 0 rgba(255, 215, 0, 0.0); }
            50% { transform: scale(1.05); box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); }
            100% { transform: scale(1.0); box-shadow: 0 0 0 rgba(255, 215, 0, 0.0); }
        }

        .rank-change {
            animation: rank-change-pulse 0.5s ease-out 1;
            color: #ffd700 !important;
        }


        /* ===========================================================
           ë°©ì†¡ ë° ë¡œë”© ìŠ¤íƒ€ì¼
        =========================================================== */
        #broadcast {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            padding: 16px 30px;
            border-radius: 12px;
            font-size: 20px;
            display: none;
            z-index: 2;
            white-space: pre-line;
            text-align: center;
            box-shadow: 0 0 20px rgba(74, 116, 255, 0.5);
        }

        /* ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <script>
        /* ===========================================================
            ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸° ìƒíƒœ (ê°œì„ ëœ êµ¬ì¡°)
        =========================================================== */
        let userId; // í˜„ì¬ ë¡œê·¸ì¸ëœ ìœ ì € ID
        let stompClient;
        let carsData = [];
        let totalRounds = 5;

        // â˜… [í•µì‹¬ ë³€ê²½] ìœ ì €ë³„ ìƒíƒœë¥¼ ì €ì¥í•˜ëŠ” ê°ì²´ (localStorage ëŒ€ì²´)
        let userSpecificData = {};

        // ìœ ì €ë³„ ì´ˆê¸° ìƒíƒœ ìƒì„± í—¬í¼
        function initializeUserData(id) {
            if (!userSpecificData[id]) {
                userSpecificData[id] = {
                    raceId: null,
                    currentRound: 1,
                    balance: 0,
                    selectedCar: null,
                    selectedMultiplier: null,
                    currentBetAmount: 0,
                    isBetting: false,
                    betTimer: 15,
                    betInterval: null,
                    previousRanks: {},
                    betHistory: [],
                    activeSubscriptions: {},
                    currentWeather: null,
                };
            }
        }


        function formatMoney(n) {
            return Number(n).toLocaleString();
        }

        /* ===========================================================
            ì”ì•¡ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        =========================================================== */
        function updateBalance(id, newBalance) {
            initializeUserData(id); // ì•ˆì „ì¥ì¹˜
            userSpecificData[id].balance = Number(newBalance);
            const data = userSpecificData[id];

            // í˜„ì¬ ë¡œê·¸ì¸ëœ ìœ ì €ì˜ UIë§Œ ì—…ë°ì´íŠ¸
            if (id === userId) {
                const lobbyBalanceEl = document.getElementById('lobbyBalance');
                if (lobbyBalanceEl)
                    lobbyBalanceEl.innerText = `ì”ì•¡: ${formatMoney(data.balance)} ì›`;

                const bettingTitleEl = document.getElementById('bettingTitle');
                if (bettingTitleEl) {
                    bettingTitleEl.innerHTML = `${data.currentRound} ë¼ìš´ë“œ ë² íŒ… (ì”ì•¡: ${formatMoney(data.balance)}ì›)
                <br><span id="betTimer" style="font-size:22px;color:#ffd700;">â³ ${data.betTimer}ì´ˆ ë‚¨ìŒ</span>`;
                }
            }
        }


        /* ================================================
   í­ì£½ + í™©ê¸ˆ í”Œë˜ì‹œ + ë² íŒ… ì„±ê³µ ì—°ì¶œ í•¨ìˆ˜
================================================= */
        function playBetSuccessEffect() {
            // 1) í…ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜ ë³´ì—¬ì£¼ê¸°
            const msg = document.getElementById("betSuccessMessage");
            msg.classList.add("active");

            setTimeout(() => {
                msg.classList.remove("active");
            }, 1200);

            // 2) í™©ê¸ˆ í”Œë˜ì‹œ
            const flash = document.getElementById("goldFlash");
            if (flash) {
                flash.style.opacity = 1;
                setTimeout(() => {
                    flash.style.opacity = 0;
                }, 500);
            }

            // 3) í­ì£½ 40ê°œ ìƒì„±
            for (let i = 0; i < 40; i++) {
                const piece = document.createElement("div");
                piece.classList.add("confetti-piece");

                piece.style.left = Math.random() * 100 + "vw";
                piece.style.animationDuration = (1 + Math.random()) + "s";

                document.body.appendChild(piece);

                // ì• ë‹ˆë©”ì´ì…˜ ëë‚˜ë©´ ì œê±°
                setTimeout(() => piece.remove(), 1800);
            }
        }


        /* ===========================================================
            ë² íŒ… UI ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜
        =========================================================== */
        function hideBettingForm() {
            // ë² íŒ… ì…ë ¥ í¼ ë° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            document.getElementById('bettingForm').classList.add("hidden");
            document.getElementById('selectedCarInfo').classList.add("hidden");
        }

        function showWaitingMessage(msg) {
            // ë² íŒ… ì„±ê³µ í›„ ëŒ€ê¸° ë©”ì‹œì§€ í‘œì‹œ
            const waitingEl = document.getElementById('waitingMessage');
            waitingEl.innerText = msg;
            waitingEl.classList.remove("hidden");
        }

        function resetBettingUI() {
            // ìƒˆ ë¼ìš´ë“œ ì‹œì‘ ì‹œ UI ì´ˆê¸°í™”
            document.getElementById('bettingForm').classList.remove("hidden");
            document.getElementById('selectedCarInfo').classList.remove("hidden");
            document.getElementById('waitingMessage').classList.add("hidden");
        }

        /* ===========================================================
            íšŒì› UI ë° ì¸ì¦ (Login/Signup)
        =========================================================== */
        function showSignup() {
            document.getElementById('loginPage').classList.add("hidden");
            document.getElementById('signupPage').classList.remove("hidden");
        }
        function showLogin() {
            document.getElementById('signupPage').classList.add("hidden");
            document.getElementById('loginPage').classList.remove("hidden");
        }

        function login() {
            const loginUser = document.getElementById('loginUser').value;
            const loginPw = document.getElementById('loginPw').value;

            fetch("/auth/login", {
                method: "POST",
                credentials: "include",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ username: loginUser, password: loginPw })
            })
                .then(async r => {
                    if (!r.ok) {
                        const errorText = await r.text();
                        alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                        throw new Error("login failed: " + errorText);
                    }
                    return r.json();
                })
                .then(data => {
                    userId = data.id;
                    initializeUserData(userId);

                    document.getElementById('loginPage').classList.add("hidden");
                    document.getElementById('lobbyPage').classList.remove("hidden");

                    loadLobby(userId);
                })
                .catch(err => console.error(err));
        }


        function signup() {
            // 1. ì…ë ¥ í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸° ë° ê³µë°± ì œê±°
            const signupUser = document.getElementById('signupUser').value.trim();
            const signupPw = document.getElementById('signupPw').value.trim();

            // 2. ë¹ˆ ê°’ ì²´í¬
            if (signupUser.length === 0) {
                alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            if (signupPw.length === 0) {
                alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            // ì„œë²„ë¡œ ìš”ì²­
            fetch("/auth/signup", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ username: signupUser, password: signupPw })
            })
                .then(() => {
                    alert("íšŒì›ê°€ì… ì™„ë£Œ");
                    showLogin();
                })
                .catch(() => alert("íšŒì›ê°€ì… ì‹¤íŒ¨"));
        }

        /* ===========================================================
    ë¡œë¹„ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° & ë­í‚¹ í‘œì‹œ
=========================================================== */
        function loadLobby(id) {
            fetch(`/user/${id}`)
                .then(r => r.json())
                .then(d => {
                    console.log(`ì”ì•¡ ìˆ˜ì‹  ë°ì´í„° (UserID: ${id}):`, d);
                    updateBalance(id, d.balance);
                })
                .catch(err => console.error(`ì”ì•¡ ë¡œë“œ ì˜¤ë¥˜ (UserID: ${id}):`, err));

            fetch("/user/ranking")
                .then(r => r.json())
                .then(list => {
                    console.log("ë­í‚¹ ìˆ˜ì‹  ë°ì´í„°:", list);
                    showRanking(list, id); // í˜„ì¬ ë¡œê·¸ì¸ ìœ ì € IDë„ ì „ë‹¬
                })
                .catch(err => console.error("ë­í‚¹ ë¡œë“œ ì˜¤ë¥˜:", err));
        }

        function showRanking(list, me) {
            let html = "";
            const rankingList = document.getElementById('rankingList');

            if (!Array.isArray(list) || list.length === 0) {
                rankingList.innerHTML = "<div style='color: #aaa;'>ë­í‚¹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
                return;
            }

            list.forEach((u, idx) => {
                const isMe = u.userId === me;

                html += `
            <div style="margin:6px 0; font-size:18px; ${isMe ? 'font-weight:bold;color:#4a74ff;' : ''}">
                ${idx + 1}ë“±&nbsp;&nbsp; ${u.username} â€” ${u.balance.toLocaleString()}ì› ${isMe ? " â† ë‚˜" : ""}
            </div>`;
            });

            rankingList.innerHTML = html;
        }

        /* ===========================================================
            ë ˆì´ìŠ¤ ì‹œì‘ & WS ì—°ê²°
        =========================================================== */
        function startRace() {
            document.getElementById('loadingOverlay').style.display = "flex";

            fetch("/race/start", {
                method: "POST",
                credentials: "include"
            })
                .then(async r => {
                    if (!r.ok) {
                        const errorText = await r.text();
                        alert("ë ˆì´ìŠ¤ ì‹œì‘ ì‹¤íŒ¨: ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                        throw new Error("Start Race failed: " + errorText);
                    }
                    return r.json();
                })
                .then(data => {
                    const raceId = data.raceId;

                    // 1. Race ID ë©”ëª¨ë¦¬ ì €ì¥
                    userSpecificData[userId].raceId = raceId;

                    document.getElementById('lobbyPage').classList.add("hidden");

                    connectWS(() => {
                        // 2. Round 1 êµ¬ë… ì‹œì‘
                        subscribeRound(userId, 1);

                        // 3. Round Next ìš”ì²­ (Race ID í¬í•¨)
                        fetch(`/race/next`, {
                            method: "POST",
                            credentials: "include",
                            headers: {"Content-Type": "application/json"},
                            body: JSON.stringify({ raceId: raceId })
                        })
                            .catch(err => {
                                // race/next ìš”ì²­ ì˜¤ë¥˜ ì²˜ë¦¬
                                console.error("Race Next Start Error:", err);
                                alert("ë‹¤ìŒ ë¼ìš´ë“œ ì‹œì‘ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.");
                            });
                    });
                })
                .catch(err => {
                    // ì´ˆê¸° race/start ì‹¤íŒ¨ ì‹œ ì˜¤ë¥˜ ì²˜ë¦¬
                    console.error("Race Start Error:", err);
                    document.getElementById('loadingOverlay').style.display = "none";
                    if (!err.message.includes("failed")) {
                        alert("ë ˆì´ìŠ¤ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                    }
                });
        }

        function connectWS(onConnected) {
            const socket = new SockJS("/ws");
            stompClient = Stomp.over(socket);

            stompClient.connect({}, frame => {
                console.log("WS Connected");
                document.getElementById('loadingOverlay').style.display = "none";

                if (onConnected) onConnected();
            });
        }


        /* ===========================================================
    ë¼ìš´ë“œ êµ¬ë…
=========================================================== */
        function subscribeRound(id, round) {
            initializeUserData(id);
            const data = userSpecificData[id];
            data.currentRound = round;

            // â˜… ê¸°ì¡´ êµ¬ë… ì œê±°
            clearPreviousSubscriptions(id);

            const raceId = data.raceId;
            const userTopicPrefix = `/topic/user/${id}/race/${round}`;

            // í˜„ì¬ ë¡œê·¸ì¸ëœ ìœ ì €ì˜ UIë§Œ ì¡°ì‘
            if (id === userId) {
                document.getElementById('raceTrack').style.display = "none";
                document.getElementById('hud').style.display = "none";
                document.getElementById('rankingDisplay').style.display = "none";

                document.getElementById('roundIndicator').innerText =
                    `ROUND ${round} / ${totalRounds}`;
                document.getElementById('roundIndicator').style.display = "block";
            }


            /* ì°¨ëŸ‰ ê·¸ë£¹ */
            data.activeSubscriptions[userTopicPrefix + "/cars/group"] =
                stompClient.subscribe(userTopicPrefix + "/cars/group", msg => {
                    // ì°¨ëŸ‰ ë°ì´í„°ëŠ” ëª¨ë“  ìœ ì €ê°€ ê³µìœ í•˜ë¯€ë¡œ ì „ì—­ ë³€ìˆ˜ carsDataì— ì €ì¥
                    carsData = JSON.parse(msg.body);

                    if (id === userId) {
                        document.getElementById('raceTrack').style.display = "block";
                        document.getElementById('hud').style.display = "block";
                        document.getElementById('rankingDisplay').style.display = "block";
                    }
                });

            /* ë‚ ì”¨ */
            data.activeSubscriptions[userTopicPrefix + "/weather"] =
                stompClient.subscribe(userTopicPrefix + "/weather", msg => {
                    const w = JSON.parse(msg.body);
                    data.currentWeather = w; // ìœ ì €ë³„ ë‚ ì”¨ ì €ì¥
                });

            fetch(`/user/${id}`)
                .then(r => r.json())
                .then(user => updateBalance(id, user.balance));

            /* ë°°ë‹¹ë¥  */
            data.activeSubscriptions[userTopicPrefix + "/cars/odd"] =
                stompClient.subscribe(userTopicPrefix + "/cars/odd", msg => {
                    const oddData = JSON.parse(msg.body);
                    const odds = Array.isArray(oddData) ? oddData : (oddData.cars || oddData.odds);

                    // í˜„ì¬ ë¡œê·¸ì¸ëœ ìœ ì €ë§Œ ë² íŒ… UI í‘œì‹œ
                    if (id === userId) showBetUI(id, odds);
                });

            /* ì§„í–‰ + ì¢…ë£Œ */
            data.activeSubscriptions[userTopicPrefix] =
                stompClient.subscribe(userTopicPrefix, msg => {
                    const b = JSON.parse(msg.body);

                    if (b.type === "TURN_UPDATE") {
                        if (id === userId) {
                            updatePositions(id, b.distances);
                            updateHUD(id, data.currentWeather, b.distances);
                        }
                    }

                    if (b.type === "RACE_END") {
                        if (id === userId) {
                            showRoundResult(id, b.winner);
                        }
                    }
                });
        }

        function clearPreviousSubscriptions(id) {
            initializeUserData(id);
            const data = userSpecificData[id];

            console.log(`ğŸ”„ User ${id}ì˜ ê¸°ì¡´ êµ¬ë… ì‚­ì œ`);

            if (!stompClient || !stompClient.connected) return;

            // activeSubscriptionsì— ì €ì¥ëœ ëª¨ë“  êµ¬ë… í•´ì œ
            Object.values(data.activeSubscriptions).forEach(sub => {
                try { sub.unsubscribe(); } catch (e) { console.error(e); }
            });

            data.activeSubscriptions = {};  // ì´ˆê¸°í™”
        }


        /* ===========================================================
            ì°¨ ì´ë¯¸ì§€ ë§¤í•‘ & íŠ¸ë™ ë Œë”ë§
        =========================================================== */
        function getCarImage(name) {
            const key = name.toLowerCase().replace(/\s/g, '');

            const map = {
                "alpine": "alpine.png",
                "aston": "aston.png",
                "astonmartin": "aston.png",
                "ferrari": "ferrari.png",
                "haas": "haas.png",
                "mclaren": "mclaren.png",
                "mercedes": "mercedes.png",
                "rb": "rb.png",
                "redbull": "redbull.png",
                "redbullracing": "redbull.png",
                "sauber": "sauber.png",
                "williams": "williams.png"
            };

            const filename = map[key] || "default.png";

            return `/img/cars/${filename}`;
        }

        function renderTrack(id) {
            initializeUserData(id);
            const data = userSpecificData[id];

            if (id !== userId) return; // í˜„ì¬ ë¡œê·¸ì¸ëœ ìœ ì €ë§Œ íŠ¸ë™ ë Œë”ë§

            const raceTrack = document.getElementById('raceTrack');
            raceTrack.style.display = "block";
            document.getElementById('rankingDisplay').style.display = "flex";
            raceTrack.innerHTML = '<div id="finishLine"></div>';

            data.previousRanks = {}; // ìœ ì €ë³„ ìˆœìœ„ ì´ˆê¸°í™”

            carsData.forEach((c, i) => {
                const img = getCarImage(c.name);

                const isSelected = (data.selectedCar === c.id);

                raceTrack.innerHTML += `
            <div id="car_${c.name}"
                 class="car-container ${isSelected ? 'selected-car-glow' : ''}"
                 style="top:${40 + i * 80}px; left:0;">
                <div style="font-size:16px;font-weight:bold">${c.name}</div>
                <img src="${img}" class="car-image">
            </div>`;
            });
        }


        /* ===========================================================
    ìœ„ì¹˜ ë° ìˆœìœ„ ì—…ë°ì´íŠ¸
=========================================================== */
        function updatePositions(id, dist) {
            if (id !== userId) return;

            initializeUserData(id);
            const data = userSpecificData[id];

            const raceTrack = document.getElementById('raceTrack');
            const w = raceTrack.clientWidth;
            const rankingDisplay = document.getElementById('rankingDisplay');
            const currentDistances = [];

            Object.entries(dist).forEach(([name, d]) => {
                const km = d / 10;
                currentDistances.push({ name, distance: d, kmDistance: km });

                const px = (d / 100) * (w - 200);
                const car = document.getElementById(`car_${name}`);
                if (car) car.style.left = px + "px";
            });

            currentDistances.sort((a, b) => b.distance - a.distance);

            let rankingHTML = "";
            const currentRanks = {};

            currentDistances.forEach((item, index) => {
                const carName = item.name;
                const currentRank = index + 1;
                currentRanks[carName] = currentRank;

                const prevRank = data.previousRanks[carName]; // ìœ ì €ë³„ ì´ì „ ìˆœìœ„
                const rankChanged = prevRank !== undefined && prevRank !== currentRank;

                const animationClass = rankChanged ? 'rank-change' : '';

                rankingHTML += `
            <div id="rank_item_${carName}" class="ranking-item ${animationClass}" data-rank="${currentRank}">
                ${currentRank}ìœ„: ${carName}<br>(${item.kmDistance.toFixed(2)}km)
            </div>
        `;
            });

            rankingDisplay.innerHTML = rankingHTML;

            currentDistances.forEach((item) => {
                const carName = item.name;
                const currentRank = currentRanks[carName];
                const prevRank = data.previousRanks[carName];
                const rankChanged = prevRank !== undefined && prevRank !== currentRank;

                if (rankChanged) {
                    setTimeout(() => {
                        const el = document.getElementById(`rank_item_${carName}`);
                        if (el) {
                            el.classList.remove('rank-change');
                        }
                    }, 500);
                }
            });

            data.previousRanks = currentRanks;
        }

        /* ===========================================================
            ë² íŒ… UI í‘œì‹œ
        =========================================================== */
        function showBetUI(id, odds) {
            if (id !== userId) return;

            initializeUserData(id);
            const data = userSpecificData[id];

            data.isBetting = true;
            document.getElementById('bettingPage').classList.remove("hidden");
            // ë ˆì´ìŠ¤ í™”ë©´ ìˆ¨ê¸°ê¸°
            document.getElementById('raceTrack').style.display = "none";
            document.getElementById('hud').style.display = "none";
            document.getElementById('rankingDisplay').style.display = "none";

            resetBettingUI();

            document.getElementById('bettingTitle').innerHTML = `${data.currentRound} ë¼ìš´ë“œ ë² íŒ… (ì”ì•¡: ${data.balance.toLocaleString()}ì›)
            <br><span id="betTimer" style="font-size:22px;color:#ffd700;">â³ ${data.betTimer}ì´ˆ ë‚¨ìŒ</span>`;

            const limitAmount = Math.floor(data.balance * 0.6);

            // ë² íŒ… ì´ˆê¸°í™”
            data.selectedCar = null;
            data.selectedMultiplier = null;
            document.getElementById('betInput').value = "";
            document.getElementById('betInput').placeholder = `ìµœëŒ€ ${limitAmount.toLocaleString()}ì› (60%) ê°€ëŠ¥`;
            document.getElementById('betInput').disabled = true;
            document.getElementById('confirmBetBtn').disabled = true;
            document.getElementById('selectedCarInfo').innerHTML = "ì°¨ëŸ‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";

            clearInterval(data.betInterval);
            data.betTimer = 15;

            data.betInterval = setInterval(() => {
                data.betTimer--;
                const timerEl = document.getElementById("betTimer");
                if (timerEl) timerEl.innerText = `â³ ${data.betTimer}ì´ˆ ë‚¨ìŒ`;

                if (data.betTimer <= 0) {
                    clearInterval(data.betInterval);
                    showBroadcast("ë² íŒ… ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê³§ ë ˆì´ìŠ¤ê°€ ì‹œì‘ë©ë‹ˆë‹¤.", 2000);

                    document.getElementById('bettingPage').classList.add("hidden");

                    if (data.currentWeather) {
                        const w = data.currentWeather;
                        showBroadcast(`ë‚ ì”¨: ${w.icon} ${w.name}\n${w.commentary}`, 3000);
                    }

                    renderTrack(id);
                }
            }, 1000);

            // ì°¨ëŸ‰ ë² íŒ… ì¹´ë“œ ë Œë”ë§
            const betArea = document.getElementById("bettingCarArea");
            betArea.innerHTML = "";

            odds.forEach(o => {
                const car = carsData.find(c => c.id === o.carId);
                const carName = car ? car.name : "Unknown Car";
                const imgUrl = getCarImage(carName);

                const card = document.createElement("div");
                card.className = "bet-car-card";
                card.id = `bet_card_${o.carId}`;

                card.onclick = () => selectBetCar(id, o.carId, carName, o.multiplier);

                card.innerHTML = `
                    <div style="font-size: 26px; font-weight: bold; margin-bottom: 10px;">${carName}</div>
                    <img src="${imgUrl}" class="car-image"><br>
                    <div class="multiplier">X${o.multiplier.toFixed(2)}ë°°</div>
                `;
                betArea.appendChild(card);
            });
        }

        function selectBetCar(id, carId, name, multiplier) {
            if (id !== userId) return;

            initializeUserData(id);
            const data = userSpecificData[id];

            data.selectedCar = carId;
            data.selectedMultiplier = multiplier;
            const betInput = document.getElementById('betInput');
            const confirmBetBtn = document.getElementById('confirmBetBtn');

            document.querySelectorAll('.bet-car-card').forEach(card => {
                card.classList.remove('selected');
            });

            document.getElementById(`bet_card_${carId}`).classList.add('selected');

            document.getElementById('selectedCarInfo').innerHTML = `
                ì„ íƒ: **${name}** | **${multiplier.toFixed(2)}ë°°**<br>
                <span style="color:#2ecc71;">ë² íŒ… ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>
            `;
            betInput.disabled = false;
            confirmBetBtn.disabled = false;
            betInput.focus();
        }


        function confirmBetFinal() {
            const id = userId;
            initializeUserData(id);
            const data = userSpecificData[id];

            data.isBetting = false;

            const betInput = document.getElementById('betInput');
            const amount = parseInt(betInput.value, 10);

            data.currentBetAmount = amount;

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!data.selectedCar) {
                alert("ë² íŒ…í•  ì°¨ëŸ‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                data.isBetting = true;
                return;
            }
            const limitAmount = Math.floor(data.balance * 0.6); // ë‚´ ëˆì˜ 60%

            // ê¸ˆì•¡ì´ 60%ë¥¼ ë„˜ëŠ”ì§€ í™•ì¸
            if (amount > limitAmount) {
                alert(`ğŸ›‘ íŒŒì‚° ë°©ì§€ë¥¼ ìœ„í•´ ë³´ìœ  ê¸ˆì•¡ì˜ 60% (${limitAmount.toLocaleString()}ì›)ê¹Œì§€ë§Œ ë² íŒ…í•  ìˆ˜ ìˆì–´ìš”!`);
                betInput.value = limitAmount;
                data.isBetting = true;
                return;
            }

            // ê¸°ë³¸ ê¸ˆì•¡ ì²´í¬
            if (isNaN(amount) || amount <= 0 || amount > data.balance) {
                alert(`ìœ íš¨í•œ ë² íŒ… ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìµœëŒ€ ì”ì•¡: ${data.balance.toLocaleString()}ì›)`);
                data.isBetting = true;
                return;
            }

            const raceId = data.raceId;

            fetch("/bet/place", {
                method: "POST",
                credentials: "include",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    userId: id,
                    raceId: raceId,
                    roundId: data.currentRound,
                    carId: data.selectedCar,
                    amount: amount
                })
            }).then(response => {
                if (response.ok) {
                    return response.json();
                }
                return response.text().then(text => {
                    let errorMessage = 'ë² íŒ…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì”ì•¡ ë¶€ì¡± ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜)';
                    try {
                        const jsonError = JSON.parse(text);
                        errorMessage = jsonError.message || errorMessage;
                    } catch (e) {
                        const parts = text.split(":");
                        errorMessage = parts.length > 1 ? parts[1].trim() : text;
                    }
                    throw new Error(errorMessage);
                });
            })
                .then(resultData => {
                    updateBalance(id, resultData.newBalance);

                    hideBettingForm();
                    showWaitingMessage("ê²½ê¸° ì‹œì‘ ì¤€ë¹„ ì¤‘...");

                    showBroadcast("ë² íŒ… ì„±ê³µ!", 1500);

                    document.querySelectorAll('.bet-car-card').forEach(card => {
                        card.onclick = null;
                        card.style.opacity = 0.7;
                    });
                })
                .catch(error => {
                    alert(error.message);
                    console.error("Betting Error:", error);
                    data.isBetting = true;
                });
        }

        // ë¼ìš´ë“œ ì¢…ë£Œ
        function showRoundResult(id, result) {
            if (id !== userId) return;

            initializeUserData(id);
            const data = userSpecificData[id];

            let winnerName = "";

            if (typeof result === 'string') {
                try { winnerName = JSON.parse(result).winner; }
                catch (e) { winnerName = result; }
            } else {
                winnerName = result.winner || "ì•Œ ìˆ˜ ì—†ìŒ";
            }

            fetch(`/user/${id}`)
                .then(r => r.json())
                .then(user => {
                    updateBalance(id, user.balance);

                    const winnerCarObj = carsData.find(c => c.name === winnerName);
                    const isWin = (data.selectedCar && winnerCarObj && data.selectedCar === winnerCarObj.id);

                    const historyItem = {
                        round: data.currentRound,
                        result: isWin ? 'WIN' : 'LOSE',
                        profit: isWin ? Math.floor(data.currentBetAmount * data.selectedMultiplier - data.currentBetAmount) : -data.currentBetAmount
                    };
                    data.betHistory.push(historyItem);

                    const modal = document.getElementById('resultModal');
                    const title = document.getElementById('resultTitle');
                    const body = document.getElementById('resultBody');
                    const nextBtn = document.getElementById('modalNextBtn');

                    modal.style.display = 'flex';

                    if (isWin) {
                        // === ìŠ¹ë¦¬ ì‹œ ===
                        playBetSuccessEffect(); // í­ì£½ íš¨ê³¼!
                        title.innerText = "ğŸ‰ ë² íŒ… ì„±ê³µ! ğŸ‰";
                        title.className = "modal-title text-win";

                        const profit = Math.floor(data.currentBetAmount * data.selectedMultiplier - data.currentBetAmount);

                        body.innerHTML = `
                    <div class="result-info">
                        ìš°ìŠ¹ ì°¨ëŸ‰: <strong>${winnerName}</strong><br>
                        ë°°ë‹¹ë¥ : <span style="color:#2ecc71">${data.selectedMultiplier.toFixed(2)}ë°°</span>
                    </div>
                    <div style="background:rgba(255,215,0,0.1); padding:15px; border-radius:10px; margin-top:15px;">
                        <div style="font-size:18px; margin-bottom:5px;">ìˆ˜ìµê¸ˆ</div>
                        <div class="result-amount" style="color:#ffd700">+${formatMoney(profit)} ì›</div>
                    </div>
                    <div style="margin-top:20px; font-size:18px; color:#aaa;">
                        í˜„ì¬ ì”ì•¡: <span style="color:white">${formatMoney(user.balance)} ì›</span>
                    </div>
                `;
                    } else {
                        // === íŒ¨ë°° ì‹œ ===
                        title.innerText = "ë² íŒ… ì‹¤íŒ¨...";
                        title.className = "modal-title text-lose";

                        body.innerHTML = `
                    <div class="result-info">
                        ìš°ìŠ¹ ì°¨ëŸ‰: <strong>${winnerName}</strong><br>
                        (ë‚´ê°€ ë² íŒ…í•œ ì°¨: ${getCarNameById(data.selectedCar)})
                    </div>
                    <div style="margin-top:20px; font-size:18px; color:#aaa;">
                        í˜„ì¬ ì”ì•¡: <span style="color:white">${formatMoney(user.balance)} ì›</span>
                    </div>
                `;
                    }


                    if (data.currentRound >= totalRounds) {
                        nextBtn.innerText = "ìµœì¢… ê²°ê³¼ ë³´ê¸°";
                        nextBtn.onclick = () => showFinalResults(id);
                    } else {
                        nextBtn.innerText = "ë‹¤ìŒ ë¼ìš´ë“œ â–¶";
                        nextBtn.onclick = () => {
                            modal.style.display = 'none';
                            goToNextRound(id);
                        };
                    }
                });
        }

        function getCarNameById(id) {
            const car = carsData.find(c => c.id === id);
            return car ? car.name : "ì„ íƒ ì•ˆí•¨";
        }

        function goToNextRound(id) {
            if (id !== userId) return;

            initializeUserData(id);
            const data = userSpecificData[id];

            if (!data.raceId) {
                console.error("Race IDê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë ˆì´ìŠ¤ ì‹œì‘ì´ ëˆ„ë½ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                alert("âš ï¸ ë ˆì´ìŠ¤ ID ì˜¤ë¥˜ë¡œ ë‹¤ìŒ ë¼ìš´ë“œ ì§„í–‰ ë¶ˆê°€. ë‹¤ì‹œ ì‹œì‘í•´ì£¼ì„¸ìš”.");
                return;
            }

            document.getElementById('bettingPage').classList.add("hidden");
            document.getElementById('raceTrack').innerHTML = '';
            document.getElementById('rankingDisplay').innerHTML = '';

            data.currentRound++;
            data.previousRanks = {};

            console.log(`ë””ë²„ê·¸: ë‹¤ìŒ ë¼ìš´ë“œ ìš”ì²­ - UserId: ${id}, Stored RaceId: ${data.raceId}, Next Round: ${data.currentRound}`);

            fetch(`/race/next`, {
                method: "POST",
                credentials: "include",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ raceId: data.raceId })
            }).then(r => {
                if (!r.ok) {
                    console.error(`POST /race/next ì‹¤íŒ¨: HTTP ìƒíƒœ ${r.status}`);
                    return r.text().then(text => { throw new Error(`ë¼ìš´ë“œ ì§„í–‰ ì‹¤íŒ¨: ${text}`); });
                }
                return r.json();
            })
                .then(raceData => {
                    subscribeRound(id, data.currentRound);
                })
                .catch(error => {
                    alert(error.message);
                    console.error("ë¼ìš´ë“œ ì§„í–‰ ì¤‘ ì¹˜ëª…ì ì¸ ì˜¤ë¥˜ ë°œìƒ:", error);
                });
        }

        function showFinalResults(id) {
            if (id !== userId) return;

            initializeUserData(id);
            const data = userSpecificData[id];

            const modal = document.getElementById('resultModal');
            const title = document.getElementById('resultTitle');
            const body = document.getElementById('resultBody');
            const nextBtn = document.getElementById('modalNextBtn');

            title.innerText = "ğŸ ë ˆì´ìŠ¤ ì¢…ë£Œ - ìµœì¢… ì „ì  ğŸ";
            title.className = "modal-title";
            title.style.color = "#fff";

            let listHtml = '<div class="history-list">';
            let totalProfit = 0;

            data.betHistory.forEach(item => { // ìœ ì €ë³„ ì „ì  ì‚¬ìš©
                const color = item.result === 'WIN' ? '#ffd700' : '#e74c3c';
                const sign = item.result === 'WIN' ? '+' : '';
                totalProfit += item.profit;

                listHtml += `
            <div class="history-item">
                <span>${item.round} ë¼ìš´ë“œ</span>
                <span style="font-weight:bold; color:${color}">${item.result}</span>
                <span style="color:#fff">${sign}${formatMoney(item.profit)}ì›</span>
            </div>
        `;
            });
            listHtml += '</div>';

            const totalColor = totalProfit >= 0 ? '#ffd700' : '#e74c3c';
            const totalSign = totalProfit >= 0 ? '+' : '';

            body.innerHTML = `
        <div style="font-size:22px; margin-bottom:15px;">
            ìµœì¢… ì†ìµ: <strong style="color:${totalColor}">${totalSign}${formatMoney(totalProfit)} ì›</strong>
        </div>
        ${listHtml}
    `;

            nextBtn.innerText = "ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°";
            nextBtn.className = "btn-red";
            nextBtn.onclick = () => {
                modal.style.display = 'none';

                const raceContent = document.getElementById('raceContent');
                if (raceContent) {
                    raceContent.style.display = 'none';
                }

                const loginPage = document.getElementById('loginPage');
                if (loginPage) {
                    loginPage.classList.add("hidden");
                }

                document.getElementById('lobbyPage').classList.remove("hidden");

                userSpecificData[id].currentRound = 1;
                userSpecificData[id].betHistory = [];
                userSpecificData[id].raceId = null;

                loadLobby(id);
            };
        }

        /* ===========================================================
            ë°©ì†¡ í…ìŠ¤íŠ¸
        =========================================================== */
        function showBroadcast(msg, duration = 2500) {
            const broadcast = document.getElementById('broadcast');
            // ì´ì „ ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ opacityë¥¼ 0ìœ¼ë¡œ ë°”ë¡œ ë³€ê²½
            broadcast.style.opacity = 0;
            broadcast.style.display = "block";
            broadcast.innerText = msg;

            // í˜ì´ë“œ ì¸
            setTimeout(() => broadcast.style.opacity = 1, 10);

            // í˜ì´ë“œ ì•„ì›ƒ
            setTimeout(() => broadcast.style.opacity = 0, duration);
            setTimeout(() => broadcast.style.display = "none", duration + 500);
        }
    </script>
</head>
<body>

<div id="loginPage" class="card">
    <h2>ë¡œê·¸ì¸</h2>
    <input id="loginUser" placeholder="ì•„ì´ë”” ì…ë ¥">
    <input id="loginPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
    <div class="button-group">
        <button class="btn-blue" onclick="login()">ë¡œê·¸ì¸</button>
        <button class="btn-green" onclick="showSignup()">íšŒì›ê°€ì…</button>
    </div>
</div>

<div id="signupPage" class="card hidden">
    <h2>íšŒì›ê°€ì…</h2>
    <input id="signupUser" placeholder="ì•„ì´ë”” ì…ë ¥">
    <input id="signupPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
    <div class="button-group">
        <button class="btn-green" onclick="signup()">íšŒì›ê°€ì… ì™„ë£Œ</button>
        <button class="btn-red" onclick="showLogin()">ëŒì•„ê°€ê¸°</button>
    </div>
</div>

<div id="lobbyPage" class="card hidden">
    <h2>í™˜ì˜í•©ë‹ˆë‹¤!</h2>
    <p id="lobbyBalance" style="font-size: 20px; font-weight: bold;">ì”ì•¡: -</p>

    <h3 style="margin-top: 30px;">ìœ ì € ë­í‚¹</h3>
    <div id="rankingList" style="margin-top:15px; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px; max-height: 200px; overflow-y: auto;"></div>

    <button class="btn-blue" onclick="startRace()" style="width: 100%; margin-top: 30px; padding: 15px;">ë ˆì´ìŠ¤ ì‹œì‘</button>
</div>

<div id="bettingPage" class="hidden"
     style="
       position:fixed;
       top:0; left:0; width:100%; height:100%;
       background:#0b0f14;
       color:#fff;
       z-index:9999;
       overflow-y: auto;
     ">

    <div class="betting-page-container">
        <div class="betting-title-area">
            <h2 id="bettingTitle" style="font-size:32px;"></h2>
        </div>

        <div id="bettingCarArea">
        </div>

        <div id="bettingControl">
            <div id="selectedCarInfo" style="margin-bottom:20px; font-size:24px; min-height: 50px;">
                ì°¨ëŸ‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
            </div>

            <div id="bettingForm">
                <input id="betInput"
                       placeholder="ë² íŒ… ê¸ˆì•¡ ì…ë ¥"
                       type="number"
                       min="100"
                       style="padding:15px; font-size:20px; border-radius:10px;"
                       disabled>
                <button id="confirmBetBtn"
                        onclick="confirmBetFinal()"
                        style="margin-top:20px; padding:15px 40px; font-size:22px; width: 100%;"
                        class="btn-blue"
                        disabled>ë² íŒ… ì™„ë£Œ</button>
            </div>

            <div id="waitingMessage" class="hidden" style="font-size:30px; font-weight:bold; color:#ffd700; padding:20px;">
                ê²½ê¸° ì‹œì‘ ì¤€ë¹„ ì¤‘...
            </div>
        </div>
    </div>
</div>

<div id="raceContent" style="flex-grow: 1; display: flex; flex-direction: column;">
    <div id="roundIndicator">ROUND 1 / 5</div>

    <div id="raceTrack">
        <div id="finishLine"></div>
    </div>

    <div id="rankingDisplay" style="display: none;">
    </div>

    <div id="hud" class="hidden"></div>
</div>

<div id="broadcast"></div>

<div id="loadingOverlay"
     style="
        position:fixed; top:0; left:0; width:100%; height:100%;
        background:rgba(0,0,0,0.75);
        color:white;
        display:none;
        justify-content:center;
        align-items:center;
        flex-direction:column;
        z-index:99999;
     ">

    <div class="spinner" style="
        border: 6px solid rgba(255,255,255,0.2);
        border-top: 6px solid white;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin-bottom:20px;
    "></div>

    <div style="font-size:24px; font-weight:bold;">
        ì—°ê²° ì¤‘ì…ë‹ˆë‹¤...
    </div>
</div>
<div id="goldFlash"></div>
<div id="betSuccessMessage"> ë² íŒ… ì„±ê³µ! </div>

<div id="resultModal" class="modal-overlay">
    <div class="modal-content" style="animation: popIn 0.4s ease-out;">
        <h2 id="resultTitle" class="modal-title"></h2>

        <div id="resultBody">
        </div>

        <button id="modalNextBtn" class="btn-blue" style="margin-top: 30px; width: 100%; padding: 15px;">
            ë‹¤ìŒ ë¼ìš´ë“œ â–¶
        </button>
    </div>
</div>
</body>
</html>